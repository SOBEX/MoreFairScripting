<!DOCTYPE html>
<html>

<head>
   <title>roundStats</title>
   <style>
      .full-width {
         width: 100%;
      }

      .flex-column {
         display: flex;
         flex-direction: column;
      }

      .flex-row {
         display: flex;
         flex-direction: row;
      }

      .bar-vertical {
         border: 1px solid gray;
      }

      .bar-horizontal {
         width: 100%;
         border: 1px solid gray;
      }
   </style>
   <script type="text/javascript">
      function find(ladderStats, accountId) {
         for (let ranker of ladderStats.rankers) {
            if (ranker.accountId === accountId)
               return ranker;
         }
         return null;
      }

      function preprocess(roundStats) {
         'use strict';
         let AHLadder = Object.keys(roundStats.ladders).length - 1;
         if (true) {
            window.roundStats = roundStats;
            window.AHLadder = AHLadder;
         }
         for (let ladderKey in roundStats.ladders)
            roundStats.ladders[ladderKey].rankers.sort((l, r) => l.rank > r.rank);
         roundStats.rankers = roundStats.ladders[1].rankers.map(ranker => {
            return {
               accountId: ranker.accountId,
               ahPoints: ranker.ahPoints,
               tag: ranker.tag,
               username: ranker.username,
               maxLadder: Object.values(roundStats.ladders).reduce((count, ladder) => count + (find(ladder, ranker.accountId) ? 1 : 0), 0),
               reachedAH: !!find(roundStats.ladders[AHLadder], ranker.accountId),
               becameAH: !!find(roundStats.ladders[AHLadder + 1], ranker.accountId),
               autoCount: Object.values(roundStats.ladders).slice(0, -1).reduce((count, ladder) => count + (find(ladder, ranker.accountId)?.autoPromote ? 1 : 0), 0),
               badges: []
            }
         }).sort((l, r) => l.ahPoints !== r.ahPoints ? l.ahPoints < r.ahPoints : l.accountId > r.accountId);
         //Captcha - Manual promote on every ladder
         //Cheapskate - Auto promote less than 25% of ladders
         //Mr. Robot - Auto promote 90% or more of ladders
         for (let ranker of roundStats.rankers) {
            if (ranker.reachedAH) {
               if (ranker.autoCount === 0)
                  ranker.badges.push('Captcha');
               if (ranker.autoCount < 0.25 * AHLadder)
                  ranker.badges.push('Cheapskate');
               if (ranker.autoCount >= 0.9 * AHLadder)
                  ranker.badges.push('Mr. Robot')
            }
         }
         //TODO preprocess remaining badges
         return roundStats;
      }

      async function download(season, round) {
         'use strict';
         let file = await fetch(
            `./roundStats_S${String(season).padStart(2,'0')}R${String(round).padStart(3,'0')}.json`);
         if (!file.ok)
            throw 'Season or Round not found.';
         let text = await file.text();
         let roundStats = JSON.parse(text);
         return preprocess(roundStats);
      }

      let store = {};

      async function ensure(season, round) {
         if (!(season in store))
            store[season] = {};
         if (!(round in store[season]))
            store[season][round] = await download(season, round);
         return structuredClone(store[season][round]);
      }

      async function get(season, round, ladder) {
         'use strict';
         let roundStats = await ensure(season, round);
         if (!(ladder in roundStats.ladders))
            throw 'Ladder not found.';
         let ladderStats = roundStats.ladders[ladder];
         delete roundStats.ladders;
         return [roundStats, ladderStats];
      }

      async function display(season, round, ladder) {
         'use strict';
         try {
            let [roundStats, ladderStats] = await get(season, round, ladder);
            console.log(season, round, ladder, roundStats, ladderStats);
            let laddertable = document.getElementById('laddertable'); {
               laddertable.innerHTML = '';
               let header = laddertable.insertRow(-1);
               for (let key in ladderStats.rankers[0])
                  header.insertCell(-1).innerHTML = key;
               laddertable.innerHTML = laddertable.innerHTML.replace(/td>/g, 'th>');
            }
            for (let ranker of ladderStats.rankers) {
               let row = laddertable.insertRow(-1);
               for (let key in ranker)
                  row.insertCell(-1).innerHTML = ranker[key];
            }
            let rankerstable = document.getElementById('rankerstable'); {
               rankerstable.innerHTML = '';
               let header = rankerstable.insertRow(-1);
               for (let key in roundStats.rankers[0])
                  header.insertCell(-1).innerHTML = key;
               rankerstable.innerHTML = rankerstable.innerHTML.replace(/td>/g, 'th>');
            }
            for (let ranker of roundStats.rankers) {
               let row = rankerstable.insertRow(-1);
               for (let key in ranker)
                  row.insertCell(-1).innerHTML = ranker[key];
            }
         } catch (err) {
            alert(err);
         }
      }

      function load() {
         'use strict';
         let season = document.getElementById('season').value;
         let round = document.getElementById('round').value;
         let ladder = document.getElementById('ladder').value;
         display(season, round, ladder);
      }
   </script>
</head>

<body class="flex-column" style="margin:0;">
   <div style="margin:8px">
      <label for="season">Season</label>
      <input type="number" id="season" name="season" min="2" max="99" value="2">
      <label for="round">Round</label>
      <input type="number" id="round" name="round" min="1" max="999" value="1">
      <label for="ladder">Ladder</label>
      <input type="number" id="ladder" name="ladder" min="1" max="999" value="1">
      <button onclick="load()">Load</button>
   </div>
   <div class="bar-horizontal"></div>
   <div class="flex-row">
      <div style="flex:3;">
         <table class="full-width" id="laddertable">
            <tr>
               <th>accountId</th>
               <th>bias</th>
               <th>multi</th>
               <th>points</th>
               <th>power</th>
               <th>rank</th>
               <th>username</th>
               <th>tag</th>
               <th>ahPoints</th>
               <th>grapes</th>
               <th>vinegar</th>
               <th>autoPromote</th>
               <th>you</th>
               <th>growing</th>
            </tr>
            <tr>
               <td>accountId</td>
               <td>bias</td>
               <td>multi</td>
               <td>points</td>
               <td>power</td>
               <td>rank</td>
               <td>username</td>
               <td>tag</td>
               <td>ahPoints</td>
               <td>grapes</td>
               <td>vinegar</td>
               <td>autoPromote</td>
               <td>you</td>
               <td>growing</td>
            </tr>
         </table>
      </div>
      <div class="bar-vertical"></div>
      <div style="flex:2;">
         <table class="full-width" id="badgestable">
            <tr>
               <th>Badge</th>
               <th>Description</th>
            </tr>
            <tr>
               <td>Captcha</td>
               <td>Manual promote on every ladder</td>
            </tr>
            <tr>
               <td>Cheapskate</td>
               <td>Auto promote less than 25% of ladders</td>
            </tr>
            <tr>
               <td>Mr. Robot</td>
               <td>Auto promote 90% or more of ladders</td>
            </tr>
         </table>
         <div class="bar-horizontal"></div>
         <table class="full-width" id="rankerstable">
            <tr>
               <th>accountId</th>
               <th>ahPoints</th>
               <th>tag</th>
               <th>username</th>
            </tr>
            <tr>
               <td>accountId</td>
               <td>ahPoints</td>
               <td>tag</td>
               <td>username</td>
            </tr>
         </table>
      </div>
   </div>
   </div>
</body>

</html>